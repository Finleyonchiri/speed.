<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amora - Find Your Match</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            padding: 20px;
        }
        .auth-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .auth-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 40px 20px;
            text-align: center;
            color: white;
        }
        .auth-body {
            padding: 40px;
        }
        .btn-amora {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            color: white;
            padding: 12px;
            width: 100%;
            font-weight: bold;
        }
        .spinner-border {
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="auth-card">
                    <div class="auth-header">
                        <h1 class="display-5 fw-bold">Amora</h1>
                        <p class="mb-0">Find your perfect match today</p>
                    </div>
                    <div class="auth-body">
                        <h2 class="text-center mb-4">Welcome Back</h2>
                        
                        <div id="errorAlert" class="alert alert-danger d-none" role="alert"></div>
                        <div id="successAlert" class="alert alert-success d-none" role="alert"></div>
                        
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username or Phone Number</label>
                                <input type="text" class="form-control form-control-lg" id="username" 
                                       placeholder="Enter username or phone" required>
                            </div>
                            <div class="mb-4">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control form-control-lg" id="password" 
                                       placeholder="Enter your password" required>
                            </div>
                            <button type="submit" class="btn btn-amora btn-lg mb-3" id="loginBtn">
                                Sign In
                            </button>
                            <div class="text-center">
                                <p class="mb-0">New to Amora? 
                                    <a href="register.html" class="text-decoration-none fw-bold">Create Account</a>
                                </p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, get, query, orderByChild, equalTo } 
                from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEzRCOw2E89qjewG-vuQ_SWBWUbGdDHv8",
            authDomain: "how-fast-bcabe.firebaseapp.com",
            databaseURL: "https://how-fast-bcabe-default-rtdb.firebaseio.com",
            projectId: "how-fast-bcabe",
            storageBucket: "how-fast-bcabe.firebasestorage.app",
            messagingSenderId: "435644508816",
            appId: "1:435644508816:web:53e51d3cc22331996e4615",
            measurementId: "G-ZBZZK4D9D0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // DOM Elements
        const loginForm = document.getElementById('loginForm');
        const errorAlert = document.getElementById('errorAlert');
        const successAlert = document.getElementById('successAlert');
        const loginBtn = document.getElementById('loginBtn');

        // Login function
        async function loginUser(identifier, password) {
            try {
                loginBtn.disabled = true;
                loginBtn.innerHTML = 'Signing in... <span class="spinner-border spinner-border-sm"></span>';
                
                console.log('Attempting login with identifier:', identifier);
                
                // Query database for user by username or phone
                const usersRef = ref(database, 'users');
                
                // Try to find user by username
                let userQuery = query(usersRef, orderByChild('username'), equalTo(identifier));
                let snapshot = await get(userQuery);
                
                // If not found by username, try phone number
                if (!snapshot.exists()) {
                    console.log('Not found by username, trying phone...');
                    userQuery = query(usersRef, orderByChild('phone'), equalTo(identifier));
                    snapshot = await get(userQuery);
                }
                
                console.log('Query result:', snapshot.exists());
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    console.log('Found users:', users);
                    
                    const userKey = Object.keys(users)[0];
                    const userData = users[userKey];
                    
                    console.log('User data:', userData);
                    
                    // Check password
                    if (userData.password === password) {
                        showAlert('success', 'Login successful! Redirecting...');
                        
                        // Store user data in localStorage
                        localStorage.setItem('amora_user', JSON.stringify({
                            id: userKey,
                            username: userData.username,
                            email: userData.email,
                            phone: userData.phone
                        }));
                        
                        // Redirect to home page
                        setTimeout(() => {
                            window.location.href = 'home.html';
                        }, 1500);
                    } else {
                        showAlert('error', 'Invalid password. Please try again.');
                    }
                } else {
                    showAlert('error', 'User not found. Please check your credentials or register.');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showAlert('error', 'An error occurred. Please check database rules and try again.');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Sign In';
            }
        }

        // Show alert message
        function showAlert(type, message) {
            if (type === 'error') {
                errorAlert.textContent = message;
                errorAlert.classList.remove('d-none');
                successAlert.classList.add('d-none');
            } else {
                successAlert.textContent = message;
                successAlert.classList.remove('d-none');
                errorAlert.classList.add('d-none');
            }
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                errorAlert.classList.add('d-none');
                successAlert.classList.add('d-none');
            }, 5000);
        }

        // Form submission handler
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const identifier = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            // Basic validation
            if (!identifier) {
                showAlert('error', 'Please enter username or phone number');
                return;
            }
            
            if (!password) {
                showAlert('error', 'Please enter password');
                return;
            }
            
            // Attempt login
            await loginUser(identifier, password);
        });
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>