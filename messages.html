<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Chat - LIILA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary: #c026d3;        /* Modern purple */
            --secondary: #e91e63;       /* Pink */
            --bg-darker: #0d0012;       /* Deep purple-black */
            --bg-dark: #14001a;         /* Dark purple */
            --bg-gray: #1e0d24;         /* Purple-gray */
            --surface: #1c0f26;         /* Message background */
            --text-light: #f0e6ff;      /* Light purple text */
            --text-gray: #b39ddb;       /* Medium purple text */
            --border-dark: #3a1a4a;     /* Border color */
            --online: #00e676;          /* Online green */
            --sent-gradient: linear-gradient(145deg, #b026d3 0%, #e91e63 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            touch-action: manipulation;
            height: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-darker);
            color: var(--text-light);
            height: 100vh;
            height: -webkit-fill-available;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Main Container - WhatsApp-like two-pane layout */
        .chat-app {
            display: flex;
            height: 100vh;
            height: -webkit-fill-available;
            max-width: 1600px;
            margin: 0 auto;
            background: var(--bg-darker);
            position: relative;
        }
        
        /* Sidebar - Always visible on desktop, toggle on mobile */
        .sidebar {
            width: 400px;
            min-width: 320px;
            background: var(--bg-darker);
            border-right: 1px solid var(--border-dark);
            display: flex;
            flex-direction: column;
            transition: transform 0.28s cubic-bezier(0.32, 0.72, 0, 1);
            will-change: transform;
            z-index: 1000;
            height: 100%;
        }
        
        /* Chat Main - Takes remaining space, contains either empty state OR active chat */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
            position: relative;
            min-height: 0;
            height: 100%;
            width: 100%;
        }
        
        /* Header */
        .header {
            padding: 12px 16px;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border-dark);
            display: flex;
            align-items: center;
            min-height: 60px;
            flex-shrink: 0;
        }
        
        /* Avatar */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            background: var(--bg-gray);
            border: 2px solid var(--primary);
        }
        
        .avatar-fallback {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 16px;
        }
        
        /* Online Indicator */
        .online-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: var(--online);
            border-radius: 50%;
            border: 2px solid var(--bg-darker);
        }
        
        /* Search Bar */
        .search-bar {
            padding: 12px 16px;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border-dark);
            flex-shrink: 0;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            background: var(--bg-gray);
            border: 1px solid var(--border-dark);
            border-radius: 20px;
            color: var(--text-light);
            font-size: 14px;
            outline: none;
            position: relative;
        }
        
        .search-input:focus {
            border-color: var(--primary);
        }
        
        .search-icon {
            position: absolute;
            left: 28px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-gray);
            z-index: 1;
        }
        
        /* Conversations List */
        .conversations {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
            min-height: 0;
            overscroll-behavior: contain;
        }
        
        /* Conversation Item */
        .conversation-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(58, 26, 74, 0.3);
            flex-shrink: 0;
        }
        
        .conversation-item:hover {
            background: rgba(192, 38, 211, 0.08);
        }
        
        .conversation-item.active {
            background: rgba(192, 38, 211, 0.12);
        }
        
        .conversation-info {
            flex: 1;
            margin-left: 12px;
            min-width: 0;
            overflow: hidden;
        }
        
        .conversation-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .conversation-time {
            font-size: 12px;
            color: var(--text-gray);
            flex-shrink: 0;
            margin-left: 8px;
        }
        
        .conversation-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        
        .conversation-text {
            font-size: 13px;
            color: var(--text-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        
        /* Unread Badge */
        .unread-badge {
            background: var(--secondary);
            color: white;
            font-size: 11px;
            min-width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        /* Empty State - Full screen when no chat selected */
        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            text-align: center;
            width: 100%;
        }
        
        .empty-icon {
            font-size: 64px;
            color: var(--primary);
            opacity: 0.5;
            margin-bottom: 20px;
        }
        
        .empty-text h3 {
            color: var(--text-light);
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .empty-text p {
            color: var(--text-gray);
            margin-bottom: 24px;
        }
        
        /* Active Chat - Full screen when chat selected */
        .active-chat {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        
        /* Messages Area */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            min-height: 0;
            overscroll-behavior: contain;
            background-image:
                linear-gradient(rgba(60, 30, 80, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(60, 30, 80, 0.08) 1px, transparent 1px);
            background-size: 24px 24px;
            background-color: var(--bg-dark);
        }
        
        /* Message Container */
        .message-container {
            display: flex;
            margin-bottom: 8px;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-container.sent {
            justify-content: flex-end;
        }
        
        .message-container.received {
            justify-content: flex-start;
        }
        
        /* Message Bubble */
        .message-bubble {
            max-width: min(70%, 500px);
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            word-break: break-word;
        }
        
        .message-bubble.sent {
            background: var(--sent-gradient);
            color: white;
            border-bottom-right-radius: 6px;
        }
        
        .message-bubble.received {
            background: var(--surface);
            color: var(--text-light);
            border-bottom-left-radius: 6px;
        }
        
        .message-text {
            font-size: 15px;
            line-height: 1.4;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 4px;
            text-align: right;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
        }
        
        /* Input Area - ONLY appears when chat is active */
        .input-area {
            padding: 16px;
            background: var(--bg-darker);
            border-top: 1px solid var(--border-dark);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        
        /* Safe area insets */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .input-area {
                padding-bottom: calc(16px + env(safe-area-inset-bottom));
            }
            .mobile-nav {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        .input-wrapper {
            flex: 1;
            background: var(--bg-gray);
            border-radius: 24px;
            padding: 6px 20px;
            display: flex;
            align-items: center;
            min-height: 44px;
        }
        
        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-light);
            font-size: 15px;
            outline: none;
            padding: 4px 0;
            max-height: 100px;
            resize: none;
        }
        
        .message-input::placeholder {
            color: var(--text-gray);
        }
        
        .input-icon {
            color: var(--text-gray);
            background: none;
            border: none;
            padding: 8px;
            font-size: 20px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .input-icon:hover {
            color: var(--text-light);
        }
        
        .send-btn {
            background: var(--sent-gradient);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        
        .send-btn:hover {
            transform: scale(1.05);
        }
        
        /* New Chat Button */
        .new-chat-btn {
            background: var(--sent-gradient);
            border: none;
            color: white;
            padding: 12px 28px;
            border-radius: 24px;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .new-chat-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Mobile Navigation */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-darker);
            border-top: 1px solid var(--border-dark);
            padding: 8px 0;
            z-index: 1000;
        }
        
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .mobile-nav {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            color: var(--text-gray);
            padding: 8px 4px;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-icon {
            font-size: 20px;
            display: block;
            margin-bottom: 2px;
        }
        
        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }
        
        /* Users Modal */
        .users-modal .modal-content {
            background: var(--bg-darker);
            border: 1px solid var(--border-dark);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .users-modal .modal-header {
            border-bottom: 1px solid var(--border-dark);
            padding: 16px 20px;
        }
        
        .users-modal .modal-body {
            padding: 0;
        }
        
        .users-list {
            max-height: min(60vh, 500px);
            overflow-y: auto;
            overscroll-behavior: contain;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            border-bottom: 1px solid rgba(58, 26, 74, 0.3);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .user-item:hover {
            background: rgba(192, 38, 211, 0.08);
        }
        
        .user-info {
            flex: 1;
            margin-left: 14px;
            min-width: 0;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
            color: var(--text-light);
        }
        
        .user-status {
            font-size: 13px;
            color: var(--text-gray);
        }
        
        .online-status {
            color: var(--online);
        }
        
        /* Responsive Design */
        @media (max-width: 767.98px) {
            .sidebar {
                position: fixed;
                inset: 0;
                width: 85vw;
                max-width: 360px;
                transform: translateX(-100%);
                transition: transform 0.28s cubic-bezier(0.32, 0.72, 0, 1);
                will-change: transform;
                box-shadow: 4px 0 24px rgba(0,0,0,0.6);
                z-index: 2000;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            /* Overlay when sidebar is open */
            .sidebar.active + .overlay {
                content: "";
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.65);
                z-index: 1500;
                animation: fadeIn 0.28s ease;
            }
            
            .mobile-nav {
                display: flex;
            }
            
            /* Adjust for mobile keyboard */
            .messages-area {
                padding-bottom: calc(90px + env(safe-area-inset-bottom, 0px));
            }
            
            .input-area {
                padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
            }
            
            .conversation-item {
                padding: 10px 16px;
            }
            
            .message-bubble {
                max-width: 85%;
            }
            
            /* Hide sidebar toggle on desktop */
            .sidebar-toggle {
                display: flex !important;
            }
        }
        
        @media (min-width: 768px) {
            .sidebar-toggle {
                display: none !important;
            }
            
            .overlay {
                display: none !important;
            }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 5px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: color-mix(in srgb, var(--primary) 80%, white);
        }
        
        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(192, 38, 211, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Utility Classes */
        .sidebar-toggle {
            display: none;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            margin-right: 12px;
        }
        
        .overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.65);
            z-index: 1500;
            animation: fadeIn 0.28s ease;
        }
        
        /* Toast Notification */
        .toast-notification {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--sent-gradient);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            z-index: 3000;
            animation: slideUp 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Chat Application - Two pane layout -->
    <div class="chat-app">
        <!-- Overlay for mobile sidebar -->
        <div class="overlay" id="overlay" style="display: none;"></div>
        
        <!-- Sidebar - LEFT PANE -->
        <div class="sidebar" id="sidebar">
            <!-- Header -->
            <div class="header">
                <button class="sidebar-toggle" id="closeSidebar">
                    <i class="bi bi-x-lg"></i>
                </button>
                
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div id="myAvatar" class="avatar avatar-fallback">L</div>
                    <div>
                        <div style="font-weight: 600;">Messages</div>
                        <small style="color: var(--text-gray);">Online</small>
                    </div>
                </div>
                
                <button class="input-icon" id="newChatBtn" style="margin-left: auto;">
                    <i class="bi bi-pencil-square"></i>
                </button>
            </div>
            
            <!-- Search -->
            <div class="search-bar">
                <div style="position: relative;">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Search conversations..." id="searchInput">
                </div>
            </div>
            
            <!-- Conversations List -->
            <div class="conversations" id="conversationsList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area - RIGHT PANE -->
        <div class="chat-main" id="chatMain">
            <!-- Empty State (shown when no chat is selected) -->
            <div class="empty-chat" id="emptyChat">
                <div class="empty-icon">
                    <i class="bi bi-chat-text"></i>
                </div>
                <div class="empty-text">
                    <h3>Your messages</h3>
                    <p>Select a conversation or start a new chat</p>
                </div>
                <button class="new-chat-btn" id="startNewChatBtn">
                    <i class="bi bi-plus"></i> New Chat
                </button>
            </div>
            
            <!-- Active Chat (shown when chat is selected) -->
            <!-- NOTE: Input area is INSIDE active-chat, not separate -->
            <div class="active-chat" id="activeChat" style="display: none;">
                <!-- Header -->
                <div class="header">
                    <button class="sidebar-toggle" id="backBtn">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="position: relative;">
                            <div id="chatAvatar" class="avatar avatar-fallback">U</div>
                            <span class="online-dot" id="onlineDot" style="display: none;"></span>
                        </div>
                        <div>
                            <div style="font-weight: 600;" id="chatUserName">User Name</div>
                            <small id="chatUserStatus" style="color: var(--text-gray);">Offline</small>
                        </div>
                    </div>
                    
                    <div style="margin-left: auto; display: flex; gap: 8px;">
                        <button class="input-icon">
                            <i class="bi bi-telephone"></i>
                        </button>
                        <button class="input-icon">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Messages -->
                <div class="messages-area" id="messagesArea"></div>
                
                <!-- Message Input - ONLY appears when chat is active -->
                <div class="input-area">
                    <button class="input-icon" id="attachBtn">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                    
                    <div class="input-wrapper">
                        <textarea class="message-input" placeholder="Type a message..." 
                                  id="messageInput" rows="1"></textarea>
                        
                        <button class="input-icon" id="emojiBtn">
                            <i class="bi bi-emoji-smile"></i>
                        </button>
                    </div>
                    
                    <button class="send-btn" id="sendBtn">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <a href="home.html" class="nav-item">
            <i class="bi bi-fire nav-icon"></i>
            <span class="nav-label">Discover</span>
        </a>
        <a href="matches.html" class="nav-item">
            <i class="bi bi-heart nav-icon"></i>
            <span class="nav-label">Matches</span>
        </a>
        <a href="messages.html" class="nav-item active">
            <i class="bi bi-chat-text-fill nav-icon"></i>
            <span class="nav-label">Chat</span>
        </a>
        <a href="profile.html" class="nav-item">
            <i class="bi bi-person nav-icon"></i>
            <span class="nav-label">Profile</span>
        </a>
    </nav>
    
    <!-- Users Modal -->
    <div class="modal fade users-modal" id="usersModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 400px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">New Chat</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="search-bar">
                        <div style="position: relative;">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="Search users..." id="userSearch">
                        </div>
                    </div>
                    <div class="users-list" id="usersList">
                        <div class="loading py-4">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, get, set, push, onChildAdded, onValue, update } 
                from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDEzRCOw2E89qjewG-vuQ_SWBWUbGdDHv8",
            authDomain: "how-fast-bcabe.firebaseapp.com",
            databaseURL: "https://how-fast-bcabe-default-rtdb.firebaseio.com",
            projectId: "how-fast-bcabe",
            storageBucket: "how-fast-bcabe.firebasestorage.app",
            messagingSenderId: "435644508816",
            appId: "1:435644508816:web:53e51d3cc22331996e4615",
            measurementId: "G-ZBZZK4D9D0"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // State
        let currentUser = null;
        let conversations = [];
        let currentConversation = null;
        let messageListener = null;
        let allUsers = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check session
            const storedUser = localStorage.getItem('liila_user');
            if (!storedUser) {
                window.location.href = 'index.html';
                return;
            }
            
            try {
                currentUser = JSON.parse(storedUser);
                console.log('User loaded:', currentUser.username);
                
                // Set my avatar
                const myAvatar = document.getElementById('myAvatar');
                if (currentUser.profileImage) {
                    myAvatar.classList.remove('avatar-fallback');
                    myAvatar.src = currentUser.profileImage;
                    myAvatar.onerror = () => {
                        myAvatar.classList.add('avatar-fallback');
                        myAvatar.textContent = currentUser.fullName?.charAt(0) || currentUser.username?.charAt(0) || 'L';
                    };
                } else {
                    myAvatar.textContent = currentUser.fullName?.charAt(0) || currentUser.username?.charAt(0) || 'L';
                }
                
                await loadAllUsers();
                await loadConversations();
                setupEventListeners();
                
                // Initialize responsive behavior
                initResponsive();
                
            } catch (error) {
                console.error('Error initializing chat:', error);
                showToast('Error loading chat');
            }
        });

        // Initialize responsive behavior
        function initResponsive() {
            const isMobile = window.innerWidth < 768;
            
            if (isMobile) {
                // On mobile, hide sidebar initially
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('overlay').style.display = 'none';
            } else {
                // On desktop, show sidebar
                document.getElementById('sidebar').classList.add('active');
            }
            
            // Handle resize
            window.addEventListener('resize', () => {
                const nowMobile = window.innerWidth < 768;
                if (!nowMobile && !document.getElementById('sidebar').classList.contains('active')) {
                    // Switched to desktop - show sidebar
                    document.getElementById('sidebar').classList.add('active');
                    document.getElementById('overlay').style.display = 'none';
                }
            });
        }

        // Load all users
        async function loadAllUsers() {
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                
                allUsers = [];
                
                if (snapshot.exists()) {
                    const usersData = snapshot.val();
                    const currentUserId = currentUser.id || currentUser.username;
                    
                    Object.keys(usersData).forEach(userId => {
                        const user = usersData[userId];
                        
                        // Skip current user
                        if (userId === currentUserId || user.username === currentUser.username) {
                            return;
                        }
                        
                        const initials = user.fullName 
                            ? user.fullName.split(' ').map(n => n[0]).join('').toUpperCase()
                            : user.username.charAt(0).toUpperCase();
                        
                        allUsers.push({
                            id: userId,
                            username: user.username,
                            fullName: user.fullName || user.username,
                            profileImage: user.profileImage || '',
                            initials: initials.substring(0, 2),
                            isOnline: Math.random() > 0.5,
                            bio: user.bio || ''
                        });
                    });
                    
                    console.log(`Loaded ${allUsers.length} users`);
                }
                
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load conversations
        async function loadConversations() {
            try {
                const conversationsRef = ref(database, 'conversations');
                const snapshot = await get(conversationsRef);
                
                conversations = [];
                
                if (snapshot.exists()) {
                    const conversationsData = snapshot.val();
                    const currentUserId = currentUser.id || currentUser.username;
                    
                    Object.keys(conversationsData).forEach(conversationId => {
                        const conversation = conversationsData[conversationId];
                        
                        if (conversation.participants && 
                            conversation.participants.includes(currentUserId)) {
                            
                            const otherParticipantId = conversation.participants.find(p => p !== currentUserId);
                            
                            conversations.push({
                                id: conversationId,
                                participantId: otherParticipantId,
                                lastMessage: conversation.lastMessage || {},
                                unreadCount: conversation.unreadCount || 0,
                                timestamp: conversation.timestamp
                            });
                        }
                    });
                    
                    console.log(`Loaded ${conversations.length} conversations`);
                }
                
                displayConversations();
                
            } catch (error) {
                console.error('Error loading conversations:', error);
                document.getElementById('conversationsList').innerHTML = 
                    '<div class="text-center p-5" style="color: var(--text-gray);">Error loading conversations</div>';
            }
        }

        // Display conversations
        async function displayConversations() {
            const container = document.getElementById('conversationsList');
            
            if (conversations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="bi bi-chat-text" style="font-size: 48px; color: var(--primary); opacity: 0.5; margin-bottom: 16px;"></i>
                        <p style="color: var(--text-gray); margin-bottom: 20px;">No conversations yet</p>
                        <button class="new-chat-btn" style="padding: 10px 20px; font-size: 14px;" id="emptyNewChatBtn">
                            <i class="bi bi-plus"></i> Start New Chat
                        </button>
                    </div>
                `;
                
                document.getElementById('emptyNewChatBtn')?.addEventListener('click', openUsersModal);
                return;
            }
            
            // Sort by time
            conversations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            let html = '';
            
            for (const conversation of conversations) {
                try {
                    const userData = await getUserData(conversation.participantId);
                    if (!userData) continue;
                    
                    const time = formatTime(conversation.lastMessage?.timestamp || conversation.timestamp);
                    const lastMessage = conversation.lastMessage?.text || 'No messages yet';
                    
                    html += `
                        <div class="conversation-item" data-id="${conversation.id}" data-user="${userData.id}">
                            <div style="position: relative;">
                                ${userData.profileImage 
                                    ? `<img src="${userData.profileImage}" class="avatar" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'avatar avatar-fallback\'>${userData.initials}</div>';">`
                                    : `<div class="avatar avatar-fallback">${userData.initials}</div>`
                                }
                                ${userData.isOnline ? '<span class="online-dot"></span>' : ''}
                            </div>
                            <div class="conversation-info">
                                <div class="conversation-name">
                                    <span>${userData.fullName}</span>
                                    <span class="conversation-time">${time}</span>
                                </div>
                                <div class="conversation-preview">
                                    <div class="conversation-text">${lastMessage}</div>
                                    ${conversation.unreadCount > 0 ? 
                                        `<span class="unread-badge">${conversation.unreadCount}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading conversation user:', error);
                }
            }
            
            container.innerHTML = html;
            
            // Add click listeners
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.addEventListener('click', async () => {
                    const conversationId = item.dataset.id;
                    const userId = item.dataset.user;
                    const userData = await getUserData(userId);
                    
                    if (userData) {
                        openChat(conversationId, userData);
                    }
                });
            });
        }

        // Get user data
        async function getUserData(userId) {
            // Try to find in loaded users
            let userData = allUsers.find(u => u.id === userId || u.username === userId);
            
            if (!userData) {
                // Fetch from database
                try {
                    const usersRef = ref(database, 'users');
                    const snapshot = await get(usersRef);
                    
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        
                        for (const key in users) {
                            const user = users[key];
                            if (key === userId || user.username === userId) {
                                const initials = user.fullName 
                                    ? user.fullName.split(' ').map(n => n[0]).join('').toUpperCase()
                                    : user.username.charAt(0).toUpperCase();
                                    
                                userData = {
                                    id: key,
                                    fullName: user.fullName || user.username,
                                    profileImage: user.profileImage || '',
                                    initials: initials.substring(0, 2),
                                    isOnline: Math.random() > 0.5
                                };
                                break;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error fetching user:', error);
                }
            }
            
            return userData;
        }

        // Open chat
        async function openChat(conversationId, userData) {
            try {
                // Update UI - mark active conversation
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-id="${conversationId}"]`)?.classList.add('active');
                
                currentConversation = conversationId;
                
                // HIDE empty state, SHOW active chat
                document.getElementById('emptyChat').style.display = 'none';
                document.getElementById('activeChat').style.display = 'flex';
                
                // Update header
                document.getElementById('chatUserName').textContent = userData.fullName;
                const statusEl = document.getElementById('chatUserStatus');
                const onlineDot = document.getElementById('onlineDot');
                
                if (userData.isOnline) {
                    statusEl.textContent = 'Online';
                    statusEl.style.color = 'var(--online)';
                    onlineDot.style.display = 'block';
                } else {
                    statusEl.textContent = 'Offline';
                    statusEl.style.color = 'var(--text-gray)';
                    onlineDot.style.display = 'none';
                }
                
                // Set avatar
                const chatAvatar = document.getElementById('chatAvatar');
                if (userData.profileImage) {
                    chatAvatar.classList.remove('avatar-fallback');
                    chatAvatar.src = userData.profileImage;
                    chatAvatar.onerror = () => {
                        chatAvatar.classList.add('avatar-fallback');
                        chatAvatar.textContent = userData.initials;
                    };
                } else {
                    chatAvatar.classList.add('avatar-fallback');
                    chatAvatar.textContent = userData.initials;
                }
                
                // Load messages
                await loadMessages(conversationId);
                
                // Setup real-time listener
                setupMessageListener(conversationId);
                
                // Focus input
                document.getElementById('messageInput').focus();
                
                // On mobile, hide sidebar
                if (window.innerWidth < 768) {
                    toggleSidebar(false);
                }
                
            } catch (error) {
                console.error('Error opening chat:', error);
                showToast('Error opening chat');
            }
        }

        // Load messages
        async function loadMessages(conversationId) {
            try {
                const messagesRef = ref(database, `messages/${conversationId}`);
                const snapshot = await get(messagesRef);
                
                const container = document.getElementById('messagesArea');
                container.innerHTML = '';
                
                if (snapshot.exists()) {
                    const messagesData = snapshot.val();
                    const messages = [];
                    
                    for (const key in messagesData) {
                        messages.push({
                            id: key,
                            ...messagesData[key]
                        });
                    }
                    
                    messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    // Group messages by date
                    let lastDate = null;
                    messages.forEach(message => {
                        const messageDate = new Date(message.timestamp).toDateString();
                        if (messageDate !== lastDate) {
                            const dateElement = document.createElement('div');
                            dateElement.className = 'text-center';
                            dateElement.style.cssText = 'color: var(--text-gray); font-size: 12px; margin: 16px 0; padding: 4px 12px; background: rgba(192, 38, 211, 0.1); border-radius: 12px; display: inline-block;';
                            dateElement.textContent = formatDate(message.timestamp);
                            container.appendChild(dateElement);
                            lastDate = messageDate;
                        }
                        
                        addMessageToUI(message);
                    });
                    
                    // Scroll to bottom
                    setTimeout(() => {
                        container.scrollTop = container.scrollHeight;
                    }, 100);
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 80px 20px;">
                            <i class="bi bi-chat-text" style="font-size: 48px; color: var(--primary); opacity: 0.5; margin-bottom: 16px;"></i>
                            <p style="color: var(--text-gray); margin-bottom: 8px;">No messages yet</p>
                            <p style="color: var(--text-gray); font-size: 14px;">Send a message to start the conversation</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Setup real-time listener
        function setupMessageListener(conversationId) {
            if (messageListener) {
                messageListener();
            }
            
            const messagesRef = ref(database, `messages/${conversationId}`);
            messageListener = onChildAdded(messagesRef, (snapshot) => {
                const message = snapshot.val();
                const messageId = snapshot.key;
                
                if (document.querySelector(`[data-message-id="${messageId}"]`)) return;
                
                addMessageToUI({...message, id: messageId});
                
                // Scroll to bottom
                setTimeout(() => {
                    const container = document.getElementById('messagesArea');
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                }, 100);
            });
        }

        // Add message to UI
        function addMessageToUI(message) {
            const container = document.getElementById('messagesArea');
            
            // Remove empty state if present
            const emptyState = container.querySelector('.empty-chat');
            if (emptyState) {
                emptyState.remove();
            }
            
            const isSent = message.senderId === currentUser.id || 
                          message.senderId === currentUser.username;
            
            const time = new Date(message.timestamp).toLocaleTimeString([], 
                { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-container ${isSent ? 'sent' : 'received'}`;
            messageDiv.dataset.messageId = message.id;
            
            messageDiv.innerHTML = `
                <div class="message-bubble ${isSent ? 'sent' : 'received'}">
                    <div class="message-text">${message.text}</div>
                    <div class="message-time">
                        ${time}
                        ${isSent ? '<i class="bi bi-check2-all"></i>' : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(messageDiv);
        }

        // Auto-resize textarea
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentConversation) return;
            
            try {
                const message = {
                    text: text,
                    senderId: currentUser.id || currentUser.username,
                    senderName: currentUser.fullName || currentUser.username,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                // Save to database
                const messagesRef = ref(database, `messages/${currentConversation}`);
                const newMessageRef = push(messagesRef);
                await set(newMessageRef, message);
                
                // Update conversation
                const conversationRef = ref(database, `conversations/${currentConversation}`);
                await update(conversationRef, {
                    lastMessage: message,
                    timestamp: new Date().toISOString()
                });
                
                // Clear and reset input
                input.value = '';
                autoResizeTextarea(input);
                input.focus();
                
                // Show sending feedback
                const sendBtn = document.getElementById('sendBtn');
                const originalHTML = sendBtn.innerHTML;
                sendBtn.innerHTML = '<i class="bi bi-check"></i>';
                sendBtn.disabled = true;
                
                setTimeout(() => {
                    sendBtn.innerHTML = originalHTML;
                    sendBtn.disabled = false;
                }, 1000);
                
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Error sending message');
            }
        }

        // Close chat (go back to empty state)
        function closeChat() {
            document.getElementById('emptyChat').style.display = 'flex';
            document.getElementById('activeChat').style.display = 'none';
            
            // Clear active conversation
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Remove message listener
            if (messageListener) {
                messageListener();
                messageListener = null;
            }
            
            currentConversation = null;
            
            // Clear message input
            document.getElementById('messageInput').value = '';
            autoResizeTextarea(document.getElementById('messageInput'));
        }

        // Open users modal
        async function openUsersModal() {
            const modal = new bootstrap.Modal(document.getElementById('usersModal'));
            
            // Load users
            const availableUsers = allUsers.filter(user => {
                const existingConversation = conversations.find(c => 
                    c.participantId === user.id || c.participantId === user.username
                );
                return !existingConversation;
            });
            
            displayUsersList(availableUsers);
            
            // Setup search
            const searchInput = document.getElementById('userSearch');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filtered = availableUsers.filter(user => 
                    user.fullName.toLowerCase().includes(searchTerm) ||
                    user.username.toLowerCase().includes(searchTerm) ||
                    (user.bio && user.bio.toLowerCase().includes(searchTerm))
                );
                displayUsersList(filtered);
            });
            
            modal.show();
        }

        // Display users list
        function displayUsersList(users) {
            const container = document.getElementById('usersList');
            
            if (users.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: var(--text-gray);">No users found</div>';
                return;
            }
            
            let html = '';
            users.forEach(user => {
                html += `
                    <div class="user-item" data-user-id="${user.id}">
                        <div style="position: relative;">
                            ${user.profileImage 
                                ? `<img src="${user.profileImage}" class="avatar" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'avatar avatar-fallback\'>${user.initials}</div>';">`
                                : `<div class="avatar avatar-fallback">${user.initials}</div>`
                            }
                            ${user.isOnline ? '<span class="online-dot"></span>' : ''}
                        </div>
                        <div class="user-info">
                            <div class="user-name">${user.fullName}</div>
                            <div class="user-status ${user.isOnline ? 'online-status' : ''}">
                                ${user.isOnline ? 'Online' : 'Offline'}
                            </div>
                            ${user.bio ? `<div style="font-size: 12px; color: var(--text-gray); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${user.bio}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Add click listeners
            document.querySelectorAll('.user-item').forEach(item => {
                item.addEventListener('click', async () => {
                    const userId = item.dataset.userId;
                    const userData = allUsers.find(u => u.id === userId);
                    
                    if (userData) {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('usersModal'));
                        modal.hide();
                        
                        // Create new conversation
                        await createNewConversation(userData);
                    }
                });
            });
        }

        // Create new conversation
        async function createNewConversation(userData) {
            try {
                const currentUserId = currentUser.id || currentUser.username;
                const participantId = userData.id || userData.username;
                
                // Check if conversation exists
                const existingConversation = conversations.find(c => 
                    c.participantId === participantId
                );
                
                if (existingConversation) {
                    await openChat(existingConversation.id, userData);
                    return;
                }
                
                const conversationData = {
                    participants: [currentUserId, participantId],
                    timestamp: new Date().toISOString(),
                    lastMessage: {
                        text: "You started a conversation ",
                        senderId: currentUserId,
                        senderName: currentUser.fullName || currentUser.username,
                        timestamp: new Date().toISOString(),
                        read: false
                    },
                    unreadCount: 0
                };
                
                const conversationsRef = ref(database, 'conversations');
                const newConversationRef = push(conversationsRef);
                await set(newConversationRef, conversationData);
                
                // Add to local
                const newConversation = {
                    id: newConversationRef.key,
                    participantId: participantId,
                    lastMessage: conversationData.lastMessage,
                    unreadCount: 0,
                    timestamp: conversationData.timestamp
                };
                
                conversations.push(newConversation);
                await displayConversations();
                
                // Open the chat
                await openChat(newConversationRef.key, userData);
                
                showToast(`Started chat with ${userData.fullName}`);
                
            } catch (error) {
                console.error('Error creating conversation:', error);
                showToast('Error creating chat');
            }
        }

        // Toggle sidebar
        function toggleSidebar(show) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            if (show === undefined) {
                show = !sidebar.classList.contains('active');
            }
            
            if (show) {
                sidebar.classList.add('active');
                overlay.style.display = 'block';
            } else {
                sidebar.classList.remove('active');
                overlay.style.display = 'none';
            }
        }

        // Format time
        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) {
                return 'Just now';
            } else if (diff < 3600000) {
                return Math.floor(diff / 60000) + 'm';
            } else if (diff < 86400000) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (diff < 172800000) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }

        // Format date
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 86400000) {
                return 'Today';
            } else if (diff < 172800000) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
            }
        }

        // Show toast
        function showToast(message) {
            // Remove existing toast
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Auto remove
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Send message
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', () => autoResizeTextarea(messageInput));
            
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            
            // Sidebar toggle
            document.getElementById('closeSidebar').addEventListener('click', () => toggleSidebar(false));
            
            // Overlay click to close sidebar
            document.getElementById('overlay').addEventListener('click', () => toggleSidebar(false));
            
            // Back button - closes chat, shows empty state
            document.getElementById('backBtn').addEventListener('click', closeChat);
            
            // New chat buttons
            document.getElementById('newChatBtn').addEventListener('click', openUsersModal);
            document.getElementById('startNewChatBtn').addEventListener('click', openUsersModal);
            
            // Search conversations
            document.getElementById('searchInput').addEventListener('input', function() {
                const search = this.value.toLowerCase();
                document.querySelectorAll('.conversation-item').forEach(item => {
                    const name = item.querySelector('.conversation-name span').textContent.toLowerCase();
                    if (name.includes(search) || search === '') {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
            
            // Toggle sidebar when clicking empty area on mobile
            if (window.innerWidth < 768) {
                document.querySelector('.chat-main').addEventListener('click', (e) => {
                    if (!document.getElementById('sidebar').classList.contains('active') && 
                        !e.target.closest('#activeChat')) {
                        toggleSidebar(true);
                    }
                });
            }
            
            // Mobile: show sidebar when clicking chat main (if no active chat)
            document.getElementById('chatMain').addEventListener('click', (e) => {
                if (window.innerWidth < 768 && 
                    document.getElementById('emptyChat').style.display !== 'none' &&
                    !document.getElementById('sidebar').classList.contains('active')) {
                    toggleSidebar(true);
                }
            });
        }
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>